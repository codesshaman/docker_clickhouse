#!/usr/bin/env bash

# –°–∫—Ä–∏–ø—Ç –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç —Ä–µ–∂–∏–º assume-unchanged –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞/–ø–∞–ø–∫–∏

set -e

if [ -z "$1" ]; then
    echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 <–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π-–ø—É—Ç—å>"
    exit 1
fi

TARGET="$1"

# –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –º—ã –≤ git-—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
if ! git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
    echo "‚ùå –û—à–∏–±–∫–∞: —Ç–µ–∫—É—â–µ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è Git-—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–º."
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞
if [ ! -e "$TARGET" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: —Ñ–∞–π–ª –∏–ª–∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è '$TARGET' –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç."
    exit 1
fi

# –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ assume-unchanged
ASSUMED=$(git ls-files -v | grep '^[a-z]' | awk '{print $2}')

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ —Ñ–∞–π–ª –≤ —Å–ø–∏—Å–∫–µ
if echo "$ASSUMED" | grep -Fx "$TARGET" >/dev/null 2>&1; then
    echo "üîç –§–∞–π–ª '$TARGET' —Å–µ–π—á–∞—Å: –ù–ï –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç—Å—è (assume-unchanged)."
    echo "‚û°Ô∏è  –í–∫–ª—é—á–∞—é –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –æ–±—Ä–∞—Ç–Ω–æ..."
    git update-index --no-assume-unchanged "$TARGET"
    echo "‚úÖ –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å–Ω–æ–≤–∞ –≤–∫–ª—é—á–µ–Ω–æ."
else
    echo "üîç –§–∞–π–ª '$TARGET' —Å–µ–π—á–∞—Å: –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç—Å—è Git."
    echo "‚û°Ô∏è  –û—Ç–∫–ª—é—á–∞—é –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ (assume-unchanged)..."
    git update-index --assume-unchanged "$TARGET"
    echo "‚úÖ –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ."
fi
